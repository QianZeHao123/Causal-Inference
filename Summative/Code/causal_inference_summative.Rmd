---
title: "Appendix for Causal Inference Summative"
author: "Z0195806"
date: "`r Sys.Date()`"
output: 
  pdf_document: 
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Appendix 0 Research Question

“The impact on Final Turnout Rate by Election Swing”

# Appendix 1 Read the .dta file

Data Resource: <https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/567RS6>

## 1.1 Using haven to load the "RD_IP.dta" file

```{r}
# change to current directory
setwd(getwd())
# install.packages('haven')
library(haven)
data = read_dta("./data/RD_IP.dta")
```

## 1.2 Variable Explanation

1.  **StAlphCd** - State Alpha Code: Abbreviation of the state.
2.  **CDNumAtL** - Congressional District Number at Large.
3.  **YearElec** - Year of the Election.
4.  **Ob** - Observation number or identifier.
5.  **Use** - Indicator for whether the data row is usable for analysis.
6.  **CngrsNum** - Congress Number, indicating which session of Congress.
7.  **StICPSR** - State ICPSR Code, a unique identifier for states in political databases.
8.  **StPOAbrv** - State Postal Abbreviation.
9.  **DifDPct** - Difference in Democratic Percentage points between elections.
10. **DemPct** - Percentage of vote that went to the Democratic candidate.
11. **DemWin** - Indicator of whether the Democratic candidate won.
12. **DWinPrv** - Indicator of whether the Democrat won the previous election.
13. **DWinNxt** - Indicator of whether the Democrat won the next election.
14. **DifPVDec** - Difference in Presidential Vote share by the decade.
15. **OpenSeat** - Indicates if the election was for an open seat (no incumbent).
16. **IncStatus** - Incumbency status.
17. **PrvTrmsD** - Number of previous terms served by the Democratic candidate.
18. **PrvTrmsO** - Number of previous terms served by the opposing candidate.
19. **VoteTotW** - Total votes for the winning candidate.
20. **VoteTotL** - Total votes for the losing candidate.
21. **VoteCast** - Total votes cast in the election.
22. **SoSDem** - Secretary of State is a Democrat (indicator).
23. **PrvElcOb** - Observation number of the previous election.
24. **NxtElcOb** - Observation number of the next election.
25. **DemInc** - Indicates if the incumbent is a Democrat.
26. **DemOpen** - Indicates if the open seat was previously held by a Democrat.
27. **NonDInc** - Indicates if the incumbent is not a Democrat.
28. **NonDOpen** - Indicates if the open seat was previously held by a non-Democrat.
29. **DExpAdv** - Democratic Experience Advantage.
30. **RExpAdv** - Republican Experience Advantage.
31. **ForgnPct** - Percentage of foreign-born population in the district.
32. **GovWkPct** - Percentage of government workers in the district.
33. **BlackPct** - Percentage of African American population in the district.
34. **UrbanPct** - Percentage of urban population in the district.
35. **VtTotPct** - Voter turnout percentage.
36. **DPctNxt** - Democratic vote percentage in the next election.
37. **DifDPNxt** - Difference in Democratic Percentage in the next election.
38. **DPctPrv** - Democratic vote percentage in the previous election.
39. **DifDPPrv** - Difference in Democratic Percentage in the previous election.
40. **ElcSwing** - Electoral swing.
41. **GovDem** - Indicates if the governor is a Democrat.
42. **IncDWNOM1** - NOMINATE score of the incumbent Democrat.
43. **DSpndPct** - Percentage of campaign spending by the Democrat.
44. **DDonaPct** - Percentage of donations received by the Democrat.
45. **CQRating3** - Congressional Quarterly rating for the district.
46. **DifIPPct** - Difference in Incumbent Party Percentage points.
47. **IPwin** - Incumbent Party win indicator.
48. **close05** - Close election indicator based on a margin of 0.5%.
49. **IPPctNxt** - Incumbent Party percentage in the next election.
50. **IPPctPrv** - Incumbent Party percentage in the previous election.
51. **DifIPPPrv** - Difference in Incumbent Party Percentage in the previous election.
52. **IPInc** - Incumbent Party Incumbency.
53. **PrvTrmsIP** - Previous Terms of Incumbent Party.
54. **IPExpAdv** - Incumbent Party Experience Advantage.
55. **IPSwing** - Incumbent Party Swing.
56. **CQRatingIP** - Congressional Quarterly rating based on Incumbent Party.
57. **IPSpndPct** - Incumbent Party Spending Percentage.
58. **IPDonaPct** - Incumbent Party Donation Percentage.
59. **SoSIP** - Secretary of State from Incumbent Party.
60. **GovIP** - Indicates if the governor is from the incumbent party.
61. **DifPVIP** - Difference in Presidential Vote share attributed to the incumbent party, averaged over the decade.

```{r}
# write.csv(data, "./data/RD_IP.csv", row.names = FALSE)
```

# Appendix 2 Exploratory Data Analysis

## 2.1 Load Required Libraries

```{r message=FALSE, warning=FALSE}
# Load necessary libraries from tidyverse individually
# For creating visualizations
# For data manipulation
library(dplyr)
# # For reading CSV data
# library(readr)
# For data tidying
library(tidyr)
```

## 2.2 Inspect the Dataset

```{r}
# View the first few rows of the dataset
# head(data)
# Get a summary of the dataset
# summary(data)
# Check the structure of the dataset
# str(data)
```

Check the missing values:

```{r fig.height=8.5, fig.width=6, message=FALSE, warning=FALSE}
# Checking for missing values visually
library(ggplot2)
data %>% 
  summarise_all(funs(sum(is.na(.)))) %>%
  gather(key = "variable", value = "n_missing") %>%
  ggplot(aes(x = variable, y = n_missing)) +
  geom_col() +
  coord_flip() +
  labs(x = "Variable",
       y = "Number of Missing Values",
       title = "Missing Data in Each Variable")
```

## 2.3 Initial Exploratory Data Analysis

```{r message=FALSE, warning=FALSE}
# Plotting histograms for continuous variables
# such as vote percentages and differences
library(ggplot2)
data %>% 
  select(DemPct) %>% 
  gather(key = "variable", value = "value") %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.7) +
  facet_wrap(~variable, scales = "free_x")
```

```{r message=FALSE, warning=FALSE}
ggplot(data, aes(x = ElcSwing)) +
  geom_histogram(binwidth = 0.1,
                 fill = "grey",
                 color = "black") +
  theme_minimal() +
  labs(title = "Histogram of Electoral Swing",
       subtitle = paste("Missing values: ",
                        sum(is.na(data$ElcSwing))),
       x = "Electoral Swing",
       y = "Frequency")
```

# Appendix 3 DiD

## 3.1 The Dataset

```{r}
data.did.current = data %>%
  select(DemWin, DWinPrv, DemPct, DSpndPct,
         DDonaPct, YearElec, StAlphCd,
         GovWkPct, UrbanPct, ElcSwing, StPOAbrv
  ) %>%
  drop_na() %>%
  mutate(Time = 0)

data.did.next = data %>%
  select(DWinNxt, DemWin, DPctNxt, DSpndPct,
         DDonaPct, YearElec, StAlphCd,
         GovWkPct, UrbanPct, ElcSwing, StPOAbrv
  ) %>%
  drop_na() %>%
  mutate(Time = 1)

data.did.next = data.did.next %>%
  rename(DemWin = DWinNxt,
         DWinPrv = DemWin,
         DemPct = DPctNxt)

data.did.all = bind_rows(data.did.current, data.did.next)
```

**Absolute Value of Election Swing**

```{r}
data.did.all.abs = data.did.all %>%
  mutate(Treatment = ifelse(abs(ElcSwing) > 5, 1, 0))
```

**Pos/Neg Value of Election Swing**

```{r}
data.did.all.posneg = data.did.all %>%
  mutate(TreatmentPos = ifelse(ElcSwing > 5, 1, 0)) %>%
  mutate(TreatmentNeg = ifelse(ElcSwing < -5, 1, 0))
```

## 3.2 First Differences

```{r message=FALSE, warning=FALSE}
differences <- data.did.all.posneg %>%
  group_by(Time, TreatmentNeg) %>%
  summarise(DemPct = mean(DemPct, na.rm = TRUE))
differences
```

### 3.2.1 The Average Treatment Effect (ATT)

```{r}
T0Trt0 = differences[1, 3]
T0Trt1 = differences[2, 3]
T1Trt0 = differences[3, 3]
T1Trt1 = differences[4, 3]
(T1Trt1-T1Trt0)-(T0Trt1-T0Trt0)
```

### 3.2.2 Counterfactual Outcome

```{r}
# Calculate counterfactual outcome
Trt1_counterfactual = tibble(
  Time = c(0, 1),
  TreatmentNeg = c(0, 1),
  DemPct = as.numeric(c(T0Trt1, T0Trt1-(T0Trt0-T1Trt0)))
)
# combine them together
did_plotdata = bind_rows(differences, Trt1_counterfactual)
did_plotdata
```

```{r}
differences %>%
  ggplot(aes(x=Time, y=DemPct, group=TreatmentNeg)) +
  geom_line(aes(color=TreatmentNeg), size=1.2)
```

## 3.3 Calculating the DiD Estimator via lm

```{r}
model.1 = lm(
  DemPct ~ Time * Treatment + DemWin + DWinPrv +
    DSpndPct + DDonaPct + GovWkPct + UrbanPct,
  data = data.did.all.abs
)
```

```{r}
summary(model.1)
```

```{r}
model.2 = lm(
  DemPct ~ Time * TreatmentPos + Time * TreatmentNeg +
    DemWin + DWinPrv + DSpndPct + DDonaPct +
    GovWkPct + UrbanPct,
  data = data.did.all.posneg
)
```

```{r}
summary(model.2)
```

```{r}
model.3 = lm(
  DemPct ~ Time:TreatmentNeg + TreatmentPos +
    DemWin + DWinPrv + DSpndPct + DDonaPct +
    GovWkPct + UrbanPct,
  data = data.did.all.posneg
)
```

```{r}
summary(model.3)
```

# Appendix 4 Synthetic Control

```{r}
# install.packages("Synth")
```

```{r message=FALSE, warning=FALSE}
data.synth.pre = data %>%
  select(DemWin, DWinPrv, DemPct, DSpndPct,
         DDonaPct, YearElec, StAlphCd, StPOAbrv,
         GovWkPct, UrbanPct, ElcSwing, StAlphCd, YearElec
  ) %>%
  drop_na() %>%
  mutate(Time = 0)

data.synth.post = data %>%
  select(DWinNxt, DemWin, DPctNxt, DSpndPct,
         DDonaPct, YearElec, StAlphCd, StPOAbrv,
         GovWkPct, UrbanPct, ElcSwing, StAlphCd, YearElec
  ) %>%
  drop_na() %>%
  mutate(Time = 1)

data.synth.post = data.synth.post %>%
  rename(DemWin = DWinNxt,
         DWinPrv = DemWin,
         DemPct = DPctNxt)

data.synth.all <- bind_rows(data.synth.pre, data.synth.post)
```

```{r}
# Define the treated unit - example: State with code 'CA'
treated_unit <- "CA"
```

```{r}
# Variables used as predictors
predictor_vars <-
  c("DemPct", "DSpndPct", "DDonaPct",
    "GovWkPct", "UrbanPct")
```

```{r}
is.data.frame(data.synth.all)
```

```{r}
data.synth.all = as.data.frame(data.synth.all)
class(data.synth.all)
```

```{r}
# Check for missing data by unit and year
library(dplyr)
missing_data_check <- data.synth.all %>%
  group_by(StAlphCd, YearElec) %>%
  summarize_all(funs(sum(is.na(.)))) %>%
  ungroup()

# View summary of missing data
print(missing_data_check)

```

```{r}
# Remove units/years with missing data
complete_cases_data <- data.synth.all %>%
  group_by(StAlphCd, YearElec) %>%
  filter(all(!is.na(c(DemPct, DSpndPct, DDonaPct, GovWkPct, UrbanPct, ElcSwing, DemWin)))) %>%
  ungroup()
```

```{r}
library(Synth)
data.prep <- dataprep(
  foo = complete_cases_data,
  predictors = c("DemPct", "DSpndPct", "DDonaPct", "GovWkPct", "UrbanPct", "ElcSwing"),
  predictors.op = "mean",
  time.predictors.prior = 2000:2023,
  special.predictors = list(
    list("DemWin", 2000:2023, "mean")
  ),
  dependent = "DemWin",
  unit.variable = "StAlphCd",
  unit.names.variable = "StPOAbrv",
  time.variable = "YearElec",
  treatment.identifier = 1,
  controls.identifier = setdiff(unique(complete_cases_data$StAlphCd), 1),
  time.optimize.ssr = 1930:2023,  # Ensure this period is covered by your data
  time.plot = min(complete_cases_data$YearElec):max(complete_cases_data$YearElec)
)


```
